<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAIRKEY /// TITAN PROTOCOL</title>
    
    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CLOUDFLARE TURNSTILE -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

    <style>
        /* === SYSTEM VARIABLES === */
        :root {
            --bg-void: #020202;
            --panel-dark: #0a0a0c;
            --neon-cyan: #00f3ff;
            --neon-purple: #bc13fe;
            --alert-red: #ff003c;
            --matrix-green: #00ff41;
            --font-main: 'Fira Code', monospace;
            --font-head: 'Orbitron', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        
        body {
            background-color: var(--bg-void);
            color: var(--neon-cyan);
            font-family: var(--font-main);
            height: 100vh; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        /* === VISUAL FX === */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%; z-index: 10; pointer-events: none;
        }
        
        .noise-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://raw.githubusercontent.com/HairBaconGamming/KeySystem/main/assets/noise.png'); 
            opacity: 0.05; z-index: 1; pointer-events: none; animation: noise 0.5s steps(5) infinite;
        }
        @keyframes noise { 0% { background-position: 0 0; } 100% { background-position: 100% 100%; } }

        /* === MAIN CARD === */
        .cyber-card {
            width: 100%; max-width: 500px;
            background: rgba(10, 10, 12, 0.95);
            border: 1px solid #333;
            box-shadow: 0 0 40px rgba(0, 243, 255, 0.1);
            position: relative; z-index: 5;
            padding: 2px;
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
        }

        .inner-content {
            background: var(--panel-dark);
            padding: 30px;
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
        }

        /* HEADER */
        .header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid rgba(0, 243, 255, 0.2); padding-bottom: 20px; }
        h1 { font-family: var(--font-head); font-size: 2rem; letter-spacing: 4px; color: #fff; text-shadow: 0 0 10px var(--neon-cyan); margin-bottom: 5px; }
        .sub { font-size: 0.8rem; color: #666; letter-spacing: 2px; }

        /* STATUS BADGE */
        .status-box {
            background: rgba(0, 243, 255, 0.05);
            border: 1px solid var(--neon-cyan);
            padding: 15px; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.3s;
        }
        .status-dot { width: 8px; height: 8px; background: var(--neon-cyan); box-shadow: 0 0 10px var(--neon-cyan); animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: 0.5; } }

        /* ACTION BUTTONS */
        .cyber-btn {
            width: 100%; padding: 18px; margin-top: 15px;
            background: transparent; color: var(--neon-cyan);
            border: 1px solid var(--neon-cyan);
            font-family: var(--font-head); font-weight: 700; letter-spacing: 2px;
            cursor: pointer; position: relative; overflow: hidden;
            transition: 0.3s; text-transform: uppercase;
        }
        .cyber-btn:hover { background: var(--neon-cyan); color: #000; box-shadow: 0 0 30px var(--neon-cyan); }
        .cyber-btn:disabled { border-color: #444; color: #444; cursor: not-allowed; box-shadow: none; background: transparent; }
        
        .cyber-btn.processing {
            border-color: var(--neon-purple); color: var(--neon-purple);
            animation: borderPulse 1s infinite;
        }
        @keyframes borderPulse { 50% { border-color: transparent; } }

        /* KEY DISPLAY */
        .key-vault {
            background: #000; border: 1px dashed var(--matrix-green);
            padding: 20px; text-align: center; cursor: pointer;
            margin-top: 20px; position: relative;
        }
        .key-text { font-size: 1.5rem; color: var(--matrix-green); word-break: break-all; text-shadow: 0 0 5px var(--matrix-green); }
        .key-vault:hover { background: rgba(0, 255, 65, 0.1); }

        /* UTILS */
        .hidden { display: none !important; }
        .text-err { color: var(--alert-red); }
        .text-warn { color: var(--neon-purple); }
        
        /* LOGS */
        #term-log {
            font-size: 0.7rem; color: #555; margin-top: 20px; height: 80px; overflow-y: auto;
            border-top: 1px solid #222; padding-top: 10px;
        }
    </style>
</head>
<body>

    <div class="scanlines"></div>
    <div class="noise-bg"></div>

    <div class="cyber-card">
        <div class="inner-content">
            
            <div class="header">
                <h1>HAIRKEY</h1>
                <div class="sub">TITAN PROTOCOL v5.2 // SECURE</div>
            </div>

            <!-- VIEW: CHECKPOINT / EXPIRED -->
            <div id="view-checkpoint">
                <div class="status-box" id="status-box">
                    <div class="status-dot"></div>
                    <span id="status-text">SYSTEM STANDBY</span>
                </div>

                <div id="turnstile-box" style="display: flex; justify-content: center; margin: 15px 0; min-height: 65px;"></div>

                <button id="btn-action" class="cyber-btn" onclick="handleAction()" disabled>
                    <i class="fas fa-lock"></i> INITIALIZE
                </button>
            </div>

            <!-- VIEW: SUCCESS / KEY -->
            <div id="view-success" class="hidden">
                <div class="status-box" style="border-color: var(--matrix-green);">
                    <div class="status-dot" style="background: var(--matrix-green); box-shadow: 0 0 10px var(--matrix-green);"></div>
                    <span style="color: var(--matrix-green);">ACCESS GRANTED</span>
                </div>
                
                <div class="key-vault" onclick="copyKey()">
                    <div id="final-key" class="key-text">DECRYPTING...</div>
                    <div style="font-size: 0.6rem; color: #666; margin-top: 5px;">CLICK TO COPY</div>
                </div>
            </div>

            <!-- TERMINAL LOGS -->
            <div id="term-log">
                > SYSTEM READY.<br>
                > WAITING FOR USER INPUT...
            </div>

        </div>
    </div>

    <!-- AUDIO -->
    <audio id="sfx-hover" src="https://assets.mixkit.co/active_storage/sfx/2573/2573-preview.mp3"></audio>
    <audio id="sfx-click" src="https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3"></audio>
    <audio id="sfx-success" src="https://assets.mixkit.co/active_storage/sfx/2197/2197-preview.mp3"></audio>

    <script>
        // === CONFIG ===
        const CLOUDFLARE_SITE_KEY = "0x4AAAAAABBLlduN6HavujOQ"; // <--- THAY SITE KEY CỦA BẠN
        
        // API ENDPOINTS
        const API = {
            PROFILE: '/api/profile',
            START: '/api/start-process',
            VERIFY_STEP: '/api/verify-step', 
            COMPLETE: '/api/complete-process'
        };

        // STATE
        let sessionId = null;
        let cfToken = null;

        // --- CORE LOGIC ---
        window.onload = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            sessionId = urlParams.get('id');
            const verifyToken = urlParams.get('verify_token');

            // 1. NẾU CÓ VERIFY TOKEN -> GỌI API VERIFY
            if (verifyToken) {
                log("DETECTED RETURN SIGNAL. VERIFYING...", "warn");
                setStatus("VERIFYING STEP...", "var(--neon-purple)");
                setLoading(true, "VERIFYING...");
                
                try {
                    const res = await fetch(API.VERIFY_STEP, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ sessionId, token: verifyToken })
                    });
                    const data = await res.json();
                    
                    if (data.success) {
                        log("STEP VERIFIED. UPDATING PROTOCOLS...", "success");
                        playSfx('success');
                        // Xóa token khỏi URL
                        window.history.replaceState({}, document.title, `/?id=${sessionId}`);
                    } else {
                        log("TOKEN REJECTED: " + data.error, "err");
                        setStatus("VERIFICATION FAILED", "var(--alert-red)");
                    }
                } catch (e) { 
                    log("CONNECTION ERROR DURING VERIFY", "err"); 
                }
                
                setLoading(false); // Reset nút bấm
            }

            // 2. LOAD PROFILE
            if (sessionId) {
                await loadProfile();
            } else {
                log("FATAL: MISSING SESSION ID", "err");
                document.querySelector('.cyber-card').innerHTML = `<h2 style='text-align:center;color:red'>INVALID LINK</h2><p style='text-align:center'>Please use the script to generate a link.</p>`;
            }
        };

        async function loadProfile() {
            try {
                const res = await fetch(API.PROFILE, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ sessionId })
                });
                const data = await res.json();

                if (data.success) {
                    log("PROFILE LOADED. HWID: " + data.hwidShort);
                    
                    if (data.keyStatus === "ACTIVE") {
                        showSuccess(data.currentKey);
                    } else {
                        // Hiển thị Checkpoint hiện tại
                        setupCheckpoint(data.currentStep, data.totalSteps);
                    }
                } else {
                    // Nếu lỗi (Session Lost) -> Kiểm tra xem có phải vừa xong bước cuối không
                    await checkCompletion(); 
                }
            } catch (e) { log("PROFILE LOAD ERROR", "err"); }
        }

        function setupCheckpoint(step, total) {
            const displayStep = step + 1;
            const btn = document.getElementById('btn-action');
            
            // Cập nhật trạng thái
            setStatus(total > 1 ? `CHECKPOINT ${displayStep} / ${total}` : "SECURITY CHECK", "var(--neon-cyan)");
            log(`AWAITING COMPLETION OF CHECKPOINT ${displayStep}...`);

            // Reset nút bấm về trạng thái chờ Turnstile
            btn.innerHTML = `<i class="fas fa-lock"></i> WAIT FOR CAPTCHA`;
            btn.disabled = true;
            btn.classList.remove('processing');

            // Render Turnstile
            document.getElementById('turnstile-box').innerHTML = "";
            turnstile.render('#turnstile-box', {
                sitekey: CLOUDFLARE_SITE_KEY,
                theme: 'dark',
                callback: function(token) {
                    cfToken = token;
                    // Mở khóa nút bấm khi xong Captcha
                    btn.disabled = false;
                    btn.innerHTML = `<i class="fas fa-bolt"></i> CONTINUE`;
                    btn.style.boxShadow = "0 0 20px var(--neon-cyan)";
                    playSfx('hover');
                    log("CAPTCHA SOLVED. READY.");
                }
            });
        }

        async function handleAction() {
            if(!cfToken) return;
            playSfx('click');
            setLoading(true, "GENERATING SECURE LINK...");
            
            try {
                const res = await fetch(API.START, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ sessionId, cfToken })
                });
                const data = await res.json();
                
                if(data.success) {
                    log("LINK GENERATED. REDIRECTING...");
                    // Chuyển hướng
                    window.location.href = data.link; 
                } else {
                    log("ERROR: " + data.error, "err");
                    setStatus("ERROR: " + data.error, "var(--alert-red)");
                    setTimeout(() => window.location.reload(), 2000);
                }
            } catch(e) {
                log("NETWORK ERROR", "err");
                setLoading(false);
            }
        }

        async function checkCompletion() {
            // Dành cho trường hợp session vừa bị xóa do hoàn tất -> Thử lấy key lần cuối
            const res = await fetch(API.COMPLETE, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ sessionId })
            });
            const data = await res.json();
            
            if(data.success) {
                showSuccess(data.key);
            } else {
                if (data.refresh) {
                    window.location.reload();
                } else {
                    log("SESSION EXPIRED. PLEASE GET NEW LINK.", "err");
                    setStatus("SESSION EXPIRED", "var(--alert-red)");
                }
            }
        }

        function showSuccess(key) {
            document.getElementById('view-checkpoint').classList.add('hidden');
            document.getElementById('view-success').classList.remove('hidden');
            playSfx('success');
            
            const el = document.getElementById('final-key');
            el.innerText = key;
            log("KEY DECRYPTED SUCCESSFULLY.");
        }

        function copyKey() {
            playSfx('click');
            const k = document.getElementById('final-key').innerText;
            navigator.clipboard.writeText(k);
            log("COPIED TO CLIPBOARD.");
            alert("KEY COPIED!");
        }

        // --- UTILS ---
        function log(msg, type="norm") {
            const box = document.getElementById('term-log');
            const color = type == "err" ? "var(--alert-red)" : (type=="success" ? "var(--matrix-green)" : (type=="warn" ? "var(--neon-purple)" : "#777"));
            box.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        function setStatus(text, color) {
            const box = document.getElementById('status-box');
            const txt = document.getElementById('status-text');
            const dot = document.querySelector('.status-dot');
            
            txt.innerText = text;
            txt.style.color = color;
            box.style.borderColor = color;
            dot.style.background = color;
            dot.style.boxShadow = `0 0 10px ${color}`;
        }

        function setLoading(isLoading, text) {
            const btn = document.getElementById('btn-action');
            if(isLoading) {
                btn.innerHTML = `<i class="fas fa-cog fa-spin"></i> ${text}`;
                btn.classList.add('processing');
                btn.disabled = true;
            } else {
                btn.classList.remove('processing');
                // Lưu ý: Không tự enable lại button ở đây, vì cần chờ Captcha lại
            }
        }

        function playSfx(id) {
            const audio = document.getElementById('sfx-'+id);
            if(audio) { audio.currentTime=0; audio.play().catch(()=>{}); }
        }
    </script>
</body>
</html>