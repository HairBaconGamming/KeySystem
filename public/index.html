<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAIRKEY</title>
    <style>
        /* --- CORE STYLE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background-color: #000;
            color: #0f0;
            font-family: 'Courier New', Courier, monospace;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            user-select: none;
        }

        /* --- CRT BACKGROUND --- */
        body::before {
            content: " "; display: block; position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2; background-size: 100% 2px, 3px 100%; pointer-events: none;
        }

        /* --- MAIN BOX --- */
        .container {
            width: 100%; max-width: 500px;
            text-align: center;
            z-index: 10;
            padding: 20px;
            border: 1px solid #333;
            background: rgba(0, 10, 0, 0.95);
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.1);
        }

        h1 {
            font-size: 3rem;
            letter-spacing: 5px;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #0f0;
            border-bottom: 2px solid #0f0;
            display: inline-block;
            padding-bottom: 5px;
        }

        p { color: #888; margin-bottom: 20px; font-size: 0.9rem; }

        /* --- BUTTON & STATUS --- */
        .status-box {
            font-size: 1.2rem;
            margin: 20px 0;
            min-height: 40px;
            color: #fff;
        }

        .action-btn {
            background: #0f0;
            color: #000;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            font-family: inherit;
            cursor: pointer;
            text-transform: uppercase;
            clip-path: polygon(10% 0, 100% 0, 100% 80%, 90% 100%, 0 100%, 0 20%);
            transition: 0.2s;
            animation: pulse 2s infinite;
        }
        
        .action-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px #0f0; }
        .action-btn:disabled { background: #333; color: #555; cursor: not-allowed; animation: none; box-shadow: none; }

        /* --- KEY DISPLAY --- */
        .key-box {
            display: none;
            margin-top: 20px;
            padding: 20px;
            border: 2px dashed #0f0;
            color: #0f0;
            font-size: 1.5rem;
            word-break: break-all;
            cursor: pointer;
        }
        .key-box:hover { background: rgba(0, 255, 0, 0.1); }
        .copy-hint { font-size: 0.8rem; color: #555; margin-top: 5px; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        .blink { animation: blinker 0.5s linear infinite; color: red; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body>

    <div class="container">
        <h1>HAIRKEY</h1>
        <p>SECURE VERIFICATION SYSTEM</p>

        <div id="status" class="status-box">INITIALIZING...</div>

        <button id="mainBtn" class="action-btn" onclick="handleAction()" disabled>WAITING...</button>

        <div id="keyArea" class="key-box" onclick="copyKey()">
            <span id="keyText"></span>
            <div class="copy-hint">[CLICK TO COPY]</div>
        </div>
    </div>

    <script>
        // CẤU HÌNH LINK LINKVERTISE CỦA BẠN TẠI ĐÂY
        const LINKVERTISE_URL = "https://link-hub.net/924538/1ISw87MxsYYw"; 
        
        const statusEl = document.getElementById('status');
        const btn = document.getElementById('mainBtn');
        const keyArea = document.getElementById('keyArea');
        
        let currentState = "loading"; // loading | ready_to_ad | complete

        window.onload = async function() {
            // TRƯỜNG HỢP 1: QUAY LẠI TỪ ADS (#completed)
            if (window.location.hash === "#completed") {
                statusEl.innerText = "VERIFYING AD VIEW...";
                verifyKey();
                return;
            }

            // TRƯỜNG HỢP 2: NGƯỜI DÙNG MỚI (CÓ HWID)
            const urlParams = new URLSearchParams(window.location.search);
            const hwid = urlParams.get('hwid');

            if (hwid) {
                // Tự động Start luôn không cần hỏi
                statusEl.innerText = "ESTABLISHING SECURE SESSION...";
                try {
                    const res = await fetch('/api/start-process', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ hwid })
                    });
                    const data = await res.json();
                    
                    if (data.success) {
                        localStorage.setItem('session_id', data.sessionId);
                        currentState = "ready_to_ad";
                        statusEl.innerText = "SESSION SECURED.";
                        btn.innerText = "UNLOCK KEY (WATCH AD)";
                        btn.disabled = false;
                    } else {
                        showError(data.error);
                    }
                } catch (e) { showError("SERVER OFFLINE"); }
            } else {
                showError("INVALID LINK (MISSING HWID)");
            }
        };

        function handleAction() {
            if (currentState === "ready_to_ad") {
                // Mở link quảng cáo
                window.open(LINKVERTISE_URL, '_blank');
                statusEl.innerText = "WAITING FOR COMPLETION...";
                btn.innerText = "CHECKING...";
                btn.disabled = true;
            }
        }

        async function verifyKey() {
            const sessionId = localStorage.getItem('session_id');
            if (!sessionId) {
                showError("SESSION EXPIRED. PLEASE GET LINK AGAIN.");
                return;
            }

            try {
                const res = await fetch('/api/complete-process', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ sessionId })
                });
                const data = await res.json();

                if (data.success) {
                    // THÀNH CÔNG
                    localStorage.removeItem('session_id'); // Xóa session
                    showKey(data.key);
                } else {
                    // THẤT BẠI (Do bypass nhanh quá)
                    statusEl.innerHTML = `<span class='blink'>WARNING:</span> ${data.error}`;
                    btn.innerText = "TRY AGAIN (REFRESH)";
                    btn.disabled = false;
                    btn.onclick = () => window.location.reload();
                }
            } catch (e) { showError("VERIFICATION FAILED"); }
        }

        function showKey(key) {
            statusEl.innerText = "ACCESS GRANTED.";
            statusEl.style.color = "#0f0";
            btn.style.display = 'none'; // Ẩn nút đi
            keyArea.style.display = 'block';
            document.getElementById('keyText').innerText = key;
        }

        function showError(msg) {
            statusEl.innerText = msg;
            statusEl.style.color = "red";
            btn.disabled = true;
            btn.innerText = "ERROR";
        }

        function copyKey() {
            const k = document.getElementById('keyText').innerText;
            navigator.clipboard.writeText(k);
            alert("COPIED: " + k);
        }
    </script>
</body>
</html>